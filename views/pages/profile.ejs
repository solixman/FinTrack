<% 
  // safe helpers
  const initials = (user && user.name) 
    ? user.name.split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase() 
    : 'U';
  const avatarUrl = user && user.avatar ? user.avatar : null;
  const dobInput = user && user.dateOfBirth ? new Date(user.dateOfBirth).toISOString().split('T')[0] : '';
  const displayDob = user && user.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString() : '—';
  const displayBalance = (user && user.balance != null) ? Number(user.balance).toFixed(2) : '0.00';
%>

  <div class="card shadow-sm overflow-hidden">
    <div class="card-body p-4">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
          <h3 class="mb-0">Profile</h3>
          <small class="text-muted">Manage your account information</small>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
            <i class="bi bi-pencil-square"></i> Edit Profile
          </button>
          <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
            <i class="bi bi-key"></i> Change Password
          </button>
        </div>
      </div>

      <div class="row gx-4">
        <!-- Left: avatar & quick stats -->
        <div class="col-md-4 text-center">
          <div class="mb-3 d-inline-block">
            <% if (avatarUrl) { %>
              <img src="<%= avatarUrl %>" alt="Avatar" class="rounded-circle shadow-sm" style="width:160px; height:160px; object-fit:cover;">
            <% } else { %>
              <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                   style="width:160px; height:160px; background: linear-gradient(135deg,#e9ecef,#dee2e6); font-size:44px; color:#495057;">
                <%= initials %>
              </div>
            <% } %>
          </div>

          <h5 class="mb-0"><%= user.name || 'Unnamed User' %></h5>
          <small class="text-muted d-block mb-3"><%= user.email %></small>

          <div class="mt-3">
            <div class="border rounded p-3 text-start">
              <div class="d-flex justify-content-between">
                <small class="text-muted">Balance</small>
                <strong><%= displayBalance %> <%= user.currency || 'MAD' %></strong>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <small class="text-muted">Role</small>
                <span class="badge <%=
                  user.role === 'admin' ? 'bg-primary' : 'bg-secondary' %> text-white">
                  <%= user.role || 'user' %>
                </span>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <small class="text-muted">Status</small>
                <span class="badge <%=
                  user.status === 'active' ? 'bg-success' : user.status === 'suspended' ? 'bg-warning text-dark' : 'bg-danger' %>">
                  <%= user.status || 'active' %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: detailed info -->
        <div class="col-md-8">
          <div class="row mb-2">
            <div class="col-sm-6">
              <label class="form-label small text-muted">Full name</label>
              <div class="fw-semibold"><%= user.name || '—' %></div>
            </div>
            <div class="col-sm-6">
              <label class="form-label small text-muted">Email</label>
              <div class="fw-semibold"><%= user.email || '—' %></div>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-sm-6">
              <label class="form-label small text-muted">Phone</label>
              <div class="fw-semibold"><%= user.phoneNumber || '—' %></div>
            </div>
            <div class="col-sm-6">
              <label class="form-label small text-muted">Date of birth</label>
              <div class="fw-semibold"><%= displayDob %></div>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label small text-muted">Address</label>
            <div class="fw-semibold"><%= user.address || '—' %></div>
          </div>

          <div class="mb-2">
            <label class="form-label small text-muted">Bio</label>
            <div class="text-muted"><%= user.bio || 'No bio provided.' %></div>
          </div>

          <div class="mb-2">
            <label class="form-label small text-muted">Preferences</label>
            <div class="text-muted"><%= user.preferences ? String(user.preferences) : '—' %></div>
          </div>

          <div class="mt-4">
            <small class="text-muted">Account created</small>
            <div class="text-muted"><%= user.createdAt ? new Date(user.createdAt).toLocaleString() : '—' %></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form action="/user/update-profile" method="POST" enctype="multipart/form-data" id="editProfileForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row gx-3">
            <div class="col-md-4 text-center">
              <div class="mb-3">
                <div class="avatar-preview-wrapper mb-2">
                  <% if (avatarUrl) { %>
                    <img id="avatarPreview" src="<%= avatarUrl %>" alt="avatar preview" class="rounded-circle shadow-sm" style="width:140px;height:140px;object-fit:cover;">
                  <% } else { %>
                    <div id="avatarPreview" class="rounded-circle d-inline-flex align-items-center justify-content-center"
                         style="width:140px;height:140px;background:#f1f3f5;font-size:32px;color:#495057;">
                      <%= initials %>
                    </div>
                  <% } %>
                </div>

                <div>
                  <label class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-upload"></i> Upload Avatar
                    <input type="file" id="avatarInput" name="avatar" accept="image/*" hidden>
                  </label>
                </div>

                <small class="text-muted d-block mt-2">Max 2MB. JPG, PNG, GIF accepted.</small>
              </div>
            </div>

            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">Full name</label>
                <input name="name" type="text" class="form-control" value="<%= user.name || '' %>" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Email</label>
                <input name="email" type="email" class="form-control" value="<%= user.email || '' %>" required>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Phone</label>
                  <input name="phoneNumber" type="text" class="form-control" value="<%= user.phoneNumber || '' %>">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Currency</label>
                  <input name="currency" type="text" class="form-control" value="<%= user.currency || 'MAD' %>" required>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Date of Birth</label>
                <input name="dateOfBirth" type="date" class="form-control" value="<%= dobInput %>">
              </div>

              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea name="address" class="form-control" rows="2"><%= user.address || '' %></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Bio</label>
                <textarea name="bio" class="form-control" rows="3"><%= user.bio || '' %></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Preferences (JSON/text)</label>
                <textarea name="preferences" class="form-control" rows="2"><%= user.preferences || '' %></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <form id="changePasswordForm" action="/user/change-password" method="POST" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Old password</label>
            <input name="oldPassword" type="password" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">New password</label>
            <input id="newPassword" name="newPassword" type="password" class="form-control" minlength="8" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Confirm new password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" class="form-control" minlength="8" required>
            <div class="invalid-feedback" id="passwordMismatchFeedback">Passwords do not match.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Update password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Avatar preview (Edit Profile modal)
  (function(){
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');

    if (avatarInput && avatarPreview) {
      avatarInput.addEventListener('change', (evt) => {
        const file = evt.target.files && evt.target.files[0];
        if (!file) return;
        const maxMB = 2;
        if (file.size > maxMB * 1024 * 1024) {
          alert('File too large. Max ' + maxMB + ' MB.');
          avatarInput.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          if (avatarPreview.tagName === 'IMG') {
            avatarPreview.src = e.target.result;
          } else {
            // replace placeholder with image
            const img = document.createElement('img');
            img.id = 'avatarPreview';
            img.src = e.target.result;
            img.alt = 'avatar preview';
            img.className = 'rounded-circle shadow-sm';
            img.style.width = '140px';
            img.style.height = '140px';
            img.style.objectFit = 'cover';
            avatarPreview.replaceWith(img);
          }
        };
        reader.readAsDataURL(file);
      });
    }
  })();

  // Change password validation: ensure new & confirm match
  (function(){
    const form = document.getElementById('changePasswordForm');
    if (!form) return;

    form.addEventListener('submit', (e) => {
      const newPwd = document.getElementById('newPassword').value;
      const confirmPwd = document.getElementById('confirmPassword').value;
      const feedback = document.getElementById('passwordMismatchFeedback');

      if (newPwd !== confirmPwd) {
        e.preventDefault();
        // show invalid feedback
        document.getElementById('confirmPassword').classList.add('is-invalid');
        if (feedback) feedback.style.display = 'block';
      } else {
        document.getElementById('confirmPassword').classList.remove('is-invalid');
        if (feedback) feedback.style.display = 'none';
      }
    });

    // clear invalid state when typing
    document.getElementById('confirmPassword').addEventListener('input', () => {
      document.getElementById('confirmPassword').classList.remove('is-invalid');
      const feedback = document.getElementById('passwordMismatchFeedback');
      if (feedback) feedback.style.display = 'none';
    });
  })();
</script>

<style>
  /* small UI polish */
  .avatar-preview-wrapper img,
  .avatar-preview-wrapper div#avatarPreview {
    transition: transform .15s ease;
  }
  .avatar-preview-wrapper img:hover {
    transform: scale(1.03);
  }
  .modal .form-label.small {
    font-size: 0.85rem;
  }
  @media (max-width: 576px) {
    .avatar-preview-wrapper img, .avatar-preview-wrapper div#avatarPreview { width:110px; height:110px; }
  }
</style>
