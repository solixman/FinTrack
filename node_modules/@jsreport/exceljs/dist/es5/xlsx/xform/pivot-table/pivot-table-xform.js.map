{"version":3,"file":"pivot-table-xform.js","names":["XmlStream","require","BaseXform","PivotTableXform","constructor","map","prepare","model","tag","render","xmlStream","rows","columns","values","metric","cacheFields","cacheId","openXml","StdDocAttributes","openNode","PIVOT_TABLE_ATTRIBUTES","name","applyNumberFormats","applyBorderFormats","applyFontFormats","applyPatternFormats","applyAlignmentFormats","applyWidthHeightFormats","dataCaption","updatedVersion","minRefreshableVersion","useAutoFormatting","itemPrintTitles","createdVersion","indent","compact","compactData","multipleFieldFilters","writeXml","length","renderPivotFields","rowIndex","join","columnIndex","closeNode","parseOpen","node","parseText","text","parseClose","reconcile","options","pivotTable","cacheField","fieldIndex","fieldType","indexOf","renderPivotField","sharedItems","defaultAttributes","axis","item","index","xmlns","module","exports"],"sources":["../../../../../lib/xlsx/xform/pivot-table/pivot-table-xform.js"],"sourcesContent":["const XmlStream = require('../../../utils/xml-stream');\nconst BaseXform = require('../base-xform');\n\nclass PivotTableXform extends BaseXform {\n  constructor() {\n    super();\n\n    this.map = {};\n  }\n\n  prepare(model) {\n    // TK\n  }\n\n  get tag() {\n    // http://www.datypic.com/sc/ooxml/e-ssml_pivotTableDefinition.html\n    return 'pivotTableDefinition';\n  }\n\n  render(xmlStream, model) {\n    // eslint-disable-next-line no-unused-vars\n    const {rows, columns, values, metric, cacheFields, cacheId} = model;\n\n    // Examples\n    // --------\n    // rows: [0, 1], // only 2 items possible for now\n    // columns: [2], // only 1 item possible for now\n    // values: [4], // only 1 item possible for now\n    // metric: 'sum', // only 'sum' possible for now\n    //\n    // the numbers are indices into `cacheFields`.\n\n    xmlStream.openXml(XmlStream.StdDocAttributes);\n    xmlStream.openNode(this.tag, {\n      ...PivotTableXform.PIVOT_TABLE_ATTRIBUTES,\n      'xr:uid': '{267EE50F-B116-784D-8DC2-BA77DE3F4F4A}',\n      name: 'PivotTable2',\n      cacheId,\n      applyNumberFormats: '0',\n      applyBorderFormats: '0',\n      applyFontFormats: '0',\n      applyPatternFormats: '0',\n      applyAlignmentFormats: '0',\n      applyWidthHeightFormats: '1',\n      dataCaption: 'Values',\n      updatedVersion: '8',\n      minRefreshableVersion: '3',\n      useAutoFormatting: '1',\n      itemPrintTitles: '1',\n      createdVersion: '8',\n      indent: '0',\n      compact: '0',\n      compactData: '0',\n      multipleFieldFilters: '0',\n    });\n\n    // Note: keeping this pretty-printed and verbose for now to ease debugging.\n    //\n    // location: ref=\"A3:E15\"\n    // pivotFields\n    // rowFields and rowItems\n    // colFields and colItems\n    // dataFields\n    // pivotTableStyleInfo\n    xmlStream.writeXml(`\n      <location ref=\"A3:E15\" firstHeaderRow=\"1\" firstDataRow=\"2\" firstDataCol=\"1\" />\n      <pivotFields count=\"${cacheFields.length}\">\n        ${renderPivotFields(model)}\n      </pivotFields>\n      <rowFields count=\"${rows.length}\">\n        ${rows.map(rowIndex => `<field x=\"${rowIndex}\" />`).join('\\n    ')}\n      </rowFields>\n      <rowItems count=\"1\">\n        <i t=\"grand\"><x /></i>\n      </rowItems>\n      <colFields count=\"${columns.length}\">\n        ${columns.map(columnIndex => `<field x=\"${columnIndex}\" />`).join('\\n    ')}\n      </colFields>\n      <colItems count=\"1\">\n        <i t=\"grand\"><x /></i>\n      </colItems>\n      <dataFields count=\"${values.length}\">\n        <dataField\n          name=\"Sum of ${cacheFields[values[0]].name}\"\n          fld=\"${values[0]}\"\n          baseField=\"0\"\n          baseItem=\"0\"\n        />\n      </dataFields>\n      <pivotTableStyleInfo\n        name=\"PivotStyleLight16\"\n        showRowHeaders=\"1\"\n        showColHeaders=\"1\"\n        showRowStripes=\"0\"\n        showColStripes=\"0\"\n        showLastColumn=\"1\"\n      />\n      <extLst>\n        <ext\n          uri=\"{962EF5D1-5CA2-4c93-8EF4-DBF5C05439D2}\"\n          xmlns:x14=\"http://schemas.microsoft.com/office/spreadsheetml/2009/9/main\"\n        >\n          <x14:pivotTableDefinition\n            hideValuesRow=\"1\"\n            xmlns:xm=\"http://schemas.microsoft.com/office/excel/2006/main\"\n          />\n        </ext>\n        <ext\n          uri=\"{747A6164-185A-40DC-8AA5-F01512510D54}\"\n          xmlns:xpdl=\"http://schemas.microsoft.com/office/spreadsheetml/2016/pivotdefaultlayout\"\n        >\n          <xpdl:pivotTableDefinition16\n            EnabledSubtotalsDefault=\"0\"\n            SubtotalsOnTopDefault=\"0\"\n          />\n        </ext>\n      </extLst>\n    `);\n\n    xmlStream.closeNode();\n  }\n\n  parseOpen(node) {\n    // TK\n  }\n\n  parseText(text) {\n    // TK\n  }\n\n  parseClose(name) {\n    // TK\n  }\n\n  reconcile(model, options) {\n    // TK\n  }\n}\n\n// Helpers\n\nfunction renderPivotFields(pivotTable) {\n  /* eslint-disable no-nested-ternary */\n  return pivotTable.cacheFields\n    .map((cacheField, fieldIndex) => {\n      const fieldType =\n        pivotTable.rows.indexOf(fieldIndex) >= 0\n          ? 'row'\n          : pivotTable.columns.indexOf(fieldIndex) >= 0\n          ? 'column'\n          : pivotTable.values.indexOf(fieldIndex) >= 0\n          ? 'value'\n          : null;\n      return renderPivotField(fieldType, cacheField.sharedItems);\n    })\n    .join('');\n}\n\nfunction renderPivotField(fieldType, sharedItems) {\n  // fieldType: 'row', 'column', 'value', null\n\n  const defaultAttributes = 'compact=\"0\" outline=\"0\" showAll=\"0\" defaultSubtotal=\"0\"';\n\n  if (fieldType === 'row' || fieldType === 'column') {\n    const axis = fieldType === 'row' ? 'axisRow' : 'axisCol';\n    return `\n      <pivotField axis=\"${axis}\" ${defaultAttributes}>\n        <items count=\"${sharedItems.length + 1}\">\n          ${sharedItems.map((item, index) => `<item x=\"${index}\" />`).join('\\n              ')}\n        </items>\n      </pivotField>\n    `;\n  }\n  return `\n    <pivotField\n      ${fieldType === 'value' ? 'dataField=\"1\"' : ''}\n      ${defaultAttributes}\n    />\n  `;\n}\n\nPivotTableXform.PIVOT_TABLE_ATTRIBUTES = {\n  xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\n  'xmlns:mc': 'http://schemas.openxmlformats.org/markup-compatibility/2006',\n  'mc:Ignorable': 'xr',\n  'xmlns:xr': 'http://schemas.microsoft.com/office/spreadsheetml/2014/revision',\n};\n\nmodule.exports = PivotTableXform;\n"],"mappings":"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","ignoreList":[]}